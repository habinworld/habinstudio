<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì •ë¦¬ì‹¤(ìºì‹œ ì²­ì†Œ) Â· ê´€ë¦¬ì</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="admin-page">
  <h1>ğŸ§¹ ì •ë¦¬ì‹¤ Â· ìºì‹œ ì²­ì†Œ(ì´ë¯¸ì§€)</h1>

  <div class="top-buttons">
    <button id="btn-scan" class="btn">ìŠ¤ìº”</button>
    <button id="btn-delete" class="btn">ì˜êµ¬ì‚­ì œ ì‹¤í–‰</button>
    <a href="list.html" class="btn">ëª©ë¡ìœ¼ë¡œ</a>
  </div>

  <div id="gc-summary" class="gc-summary" style="margin:12px 0;"></div>

  <pre id="gc-log" style="white-space:pre-wrap; padding:10px; border:1px solid #ddd; border-radius:10px; min-height:160px;"></pre>

  <script>
    // âœ… ê´€ë¦¬ìë§Œ
    window.IS_ADMIN = localStorage.getItem("habin_admin") === "true";
    if (!window.IS_ADMIN) {
      alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      location.href = "index.html";
    }
  </script>

  <!-- âœ… ë‹¨ì¼ì§„ì‹¤(ì´ë¯¸ì§€) -->
  <script src="image-store.js"></script>

  <!-- âœ… ìºì‹œ ì²­ì†Œ ì—”ì§„(ìœ ë ¹ ì´ë¯¸ì§€ ì •ë¦¬) -->
  <script src="image-store-clean.js"></script>

  <script>
    // âœ… íŒŒì¼ ì¶”ê°€ ì—†ì´ ì—¬ê¸°ì„œë§Œ ì œì–´ (ìºì‹œ ì²­ì†Œ ì „ìš©)
    const logEl = document.getElementById("gc-log");
    const sumEl = document.getElementById("gc-summary");
    const btnScan = document.getElementById("btn-scan");
    const btnDelete = document.getElementById("btn-delete");

    let last = null;

    const MB = (b) => (b / (1024 * 1024)).toFixed(2) + " MB";

    function renderSummary(r) {
      if (!r) return;
      const parts = [
        `ì´ ì´ë¯¸ì§€: <b>${r.allCount}</b>`,
        `ì‚¬ìš© ì¤‘: <b>${r.usedCount}</b>`,
        `ìœ ë ¹: <b>${r.ghostCount}</b>`
      ];
      if (typeof r.ghostBytes === "number") parts.push(`ì •ë¦¬ ê°€ëŠ¥: <b>${MB(r.ghostBytes)}</b>`);
      sumEl.innerHTML = parts.join(" <span style='color:#999;'>â€¢</span> ");
    }

    btnScan.onclick = async () => {
      logEl.textContent = "ìŠ¤ìº” ì¤‘...\n";
      const r = await ImageStoreClean.run({ dryRun: true });
      last = r;

      renderSummary(r);

      if (!r.ghostCount) {
        logEl.textContent += "ì •ë¦¬í•  ìœ ë ¹ ì´ë¯¸ì§€ ì—†ìŒ âœ…\n";
        return;
      }

      logEl.textContent += `ìœ ë ¹ ì´ë¯¸ì§€ ID (${r.ghostCount}):\n`;
      r.ghostIds.forEach(id => (logEl.textContent += `- ${id}\n`));
    };

    btnDelete.onclick = async () => {
      if (!last) {
        alert("ë¨¼ì € ìŠ¤ìº”ì„ ì‹¤í–‰í•˜ì„¸ìš”.");
        return;
      }
      if (!last.ghostCount) {
        alert("ì‚­ì œí•  ìœ ë ¹ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const input = prompt(
        `ìœ ë ¹ ì´ë¯¸ì§€ ${last.ghostCount}ê°œë¥¼ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤.\në˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nDELETE ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`
      );
      if (input !== "DELETE") return;

      logEl.textContent += "\nì˜êµ¬ ì‚­ì œ ì‹¤í–‰ ì¤‘...\n";
      const r = await ImageStoreClean.run({ dryRun: false });
      last = r;

      renderSummary(r);
      logEl.textContent += `ì™„ë£Œ âœ… ì‚­ì œ í›„ ìœ ë ¹ ì´ë¯¸ì§€: ${r.ghostCount}\n`;
    };
  </script>
</body>
</html>

